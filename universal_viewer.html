<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Universal Connector Viewer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@400;600;700&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
body{
    font-family:'Outfit',sans-serif;background:#0a1628;color:#e0e8f0;
    text-align:center;-webkit-print-color-adjust:exact;print-color-adjust:exact;min-height:100vh;
}

h2{font-weight:700;font-size:1.5rem;letter-spacing:0.5px;margin-top:18px;color:#c8daf0;}
.toolbar{margin:12px auto 4px;display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:8px;max-width:1200px;}
.toolbar-row{display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:8px;margin:4px auto;max-width:1200px;}

button{
    padding:7px 14px;font-family:'Outfit',sans-serif;font-weight:600;font-size:0.82rem;
    cursor:pointer;border:1px solid #2a4a6e;background:#12253e;color:#a0c4e8;
    border-radius:6px;transition:all 0.2s;white-space:nowrap;
}
button:hover{background:#1a3556;border-color:#3a7bd5;color:#fff;}
.nav-btn{padding:7px 11px;font-size:1rem;min-width:34px;}

select{
    padding:7px 12px;font-family:'Outfit',sans-serif;font-weight:600;font-size:0.82rem;
    border:1px solid #2a4a6e;background:#12253e;color:#a0c4e8;border-radius:6px;
    cursor:pointer;min-width:280px;transition:all 0.2s;appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23a0c4e8' fill='none' stroke-width='2'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:right 10px center;padding-right:30px;
}
select:hover{border-color:#3a7bd5;color:#fff;}
select:focus{outline:none;border-color:#3a7bd5;box-shadow:0 0 0 2px rgba(58,123,213,0.3);}

.filter-group{display:flex;align-items:center;gap:4px;}
.filter-label{font-size:0.75rem;color:#6088a8;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-right:2px;}

.checkbox-group{display:flex;align-items:center;gap:5px;cursor:pointer;user-select:none;}
.checkbox-group input[type="checkbox"]{
    appearance:none;width:15px;height:15px;border:2px solid #2a4a6e;border-radius:4px;
    background:#12253e;cursor:pointer;position:relative;transition:all 0.2s;flex-shrink:0;
}
.checkbox-group input[type="checkbox"]:checked{background:#1976d2;border-color:#3a7bd5;}
.checkbox-group input[type="checkbox"]:checked::after{
    content:'\2713';position:absolute;top:-2px;left:1px;font-size:11px;color:#fff;font-weight:bold;
}
.checkbox-group label{font-size:0.8rem;font-weight:600;color:#a0c4e8;cursor:pointer;white-space:nowrap;}
.checkbox-group.tracking-active label{color:#2ecc71;}
.checkbox-group.tracking-active input[type="checkbox"]:checked{background:#1b8a3a;border-color:#2ecc71;}

.badge{
    display:inline-block;padding:4px 12px;margin-left:8px;
    background:linear-gradient(135deg,#f0a030,#e08820);color:#1a1a1a;font-weight:700;
    font-size:0.72rem;border-radius:20px;letter-spacing:0.5px;text-transform:uppercase;
}
.badge-source{background:linear-gradient(135deg,#3a7bd5,#2a5faa);color:#fff;font-size:0.68rem;}
.badge-type{background:linear-gradient(135deg,#9c27b0,#7b1fa2);color:#fff;font-size:0.68rem;}

/* === D-Sub Connector === */
.connector-dsub{
    position:relative;margin:16px auto 20px;padding:50px 80px;
    background:linear-gradient(145deg,#0f2640,#162d4a);border-radius:70px;
    border:3px solid #1a4a78;width:max-content;transition:transform 0.3s ease;
    box-shadow:0 0 40px rgba(26,74,120,0.3),inset 0 0 60px rgba(0,0,0,0.2);
}
.connector-dsub.front-view{transform:scaleX(-1);}
.connector-dsub.front-view .inner{transform:scaleX(-1);}
.connector-dsub.front-view .pin-num-tooltip{transform:translateX(-50%) scaleX(-1);}

/* === Round Connector === */
.connector-round{
    position:relative;margin:16px auto 20px;
    width:500px;height:500px;border-radius:50%;
    background:linear-gradient(145deg,#0f2640,#162d4a);
    border:4px solid #1a4a78;
    box-shadow:0 0 40px rgba(26,74,120,0.3),inset 0 0 60px rgba(0,0,0,0.2);
}
.connector-round.front-view{transform:scaleX(-1);}
.connector-round.front-view .inner{transform:scaleX(-1);}
.connector-round.front-view .pin-num-tooltip{transform:translateX(-50%) scaleX(-1);}
.connector-round .pin{position:absolute;}

/* Common pin styles */
.connector-dsub.tracking-mode .pin,.connector-round.tracking-mode .pin{cursor:crosshair;}
.connector-dsub.edit-mode .pin,.connector-round.edit-mode .pin{cursor:cell;}

.row{display:flex;gap:20px;justify-content:center;margin:14px 0;padding:6px 10px;border-radius:20px;}
.row.zone-solid{border:2px solid rgba(255,255,255,0.1);}
.row.zone-outline{border:2px dashed rgba(255,255,255,0.08);}
.row.offset{margin-left:40px;}

.pin{
    position:relative;width:52px;height:52px;cursor:pointer;
    transition:opacity 0.3s ease,transform 0.3s ease,filter 0.3s ease;
}
.pin.dimmed{opacity:0.12;filter:grayscale(1);pointer-events:none;transform:scale(0.92);}
.pin.highlighted{transform:scale(1.1);filter:drop-shadow(0 0 6px rgba(58,123,213,0.6));}

.connector-dsub.tracking-mode .pin.done .outer::after,
.connector-round.tracking-mode .pin.done .outer::after{
    content:'\2713';position:absolute;top:0;left:0;right:0;bottom:0;
    display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;
    color:rgba(0,255,100,0.55);pointer-events:none;text-shadow:0 0 6px rgba(0,200,80,0.4);z-index:5;
}
.connector-dsub.tracking-mode .pin.done .outer,
.connector-round.tracking-mode .pin.done .outer{box-shadow:0 0 8px rgba(0,200,80,0.3);}

.pin.shared-pin .outer{border:2px dashed rgba(255,200,0,0.5);}

/* Split pin â€” same wire on multiple pins */
.pin.split-pin .outer{border:2px dotted rgba(0,200,255,0.6);}
.pin.split-pin.shared-pin .outer{border:2px dashed rgba(255,150,0,0.6);}

.pin.nc-pin{opacity:0.3;cursor:default;}
.pin.nc-pin .outer{background:#1a202c !important;border:2px dashed rgba(255,255,255,0.15);box-shadow:none;}
.pin.nc-pin .inner{background:#1a202c !important;color:#4a5568 !important;font-size:9px;}

.outer{
    position:absolute;width:100%;height:100%;border-radius:50%;
    border:1px solid rgba(0,0,0,0.4);box-shadow:0 2px 4px rgba(0,0,0,0.3);
}
.inner{
    position:absolute;width:66%;height:66%;top:17%;left:17%;border-radius:50%;
    border:1px solid rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;
    font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;color:white;
    text-align:center;padding:1px;white-space:nowrap;overflow:hidden;text-overflow:clip;
}

.pin-num-tooltip{
    position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);
    font-family:'JetBrains Mono',monospace;font-size:8px;color:#4a6a88;
    opacity:0;transition:opacity 0.2s;white-space:nowrap;pointer-events:none;
}
.pin:hover .pin-num-tooltip{opacity:1;}
.show-pin-nums .pin-num-tooltip{opacity:1;color:#7aa0c0;}
.connector-dsub.show-pin-nums .row{margin:20px 0;}

.stats-bar{margin:0 auto 4px;font-size:0.78rem;color:#5a8ab0;font-family:'JetBrains Mono',monospace;}
.stats-bar span{color:#8ac4f0;font-weight:700;}

.progress-wrap{margin:4px auto 8px;max-width:460px;display:none;}
.progress-wrap.visible{display:block;}
.progress-bar-outer{width:100%;height:18px;background:#12253e;border:1px solid #2a4a6e;border-radius:9px;overflow:hidden;}
.progress-bar-inner{height:100%;background:linear-gradient(90deg,#1b8a3a,#2ecc71);border-radius:9px;transition:width 0.4s ease;}
.progress-text{font-family:'JetBrains Mono',monospace;font-size:0.72rem;color:#6aaa80;margin-top:3px;}

.cable-legend{
    display:none;flex-wrap:wrap;justify-content:center;gap:5px 12px;margin:0 auto 12px;
    max-width:800px;padding:8px 14px;background:rgba(18,37,62,0.7);border:1px solid #1a3a5a;border-radius:10px;
}
.cable-legend.visible{display:flex;}
.legend-item{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:#6a9ac0;display:flex;align-items:center;gap:4px;}
.legend-item.is-done{color:#2ecc71;text-decoration:line-through;text-decoration-color:#2a8a4a;}
.legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block;}

.notes-panel{
    display:none;margin:0 auto 20px;max-width:900px;text-align:left;padding:14px 20px;
    background:rgba(18,37,62,0.7);border:1px solid #1a3a5a;border-radius:10px;
}
.notes-panel.visible{display:block;}
.notes-panel h3{font-size:0.85rem;color:#f0a030;margin-bottom:8px;font-weight:700;text-transform:uppercase;letter-spacing:1px;text-align:center;}
.note-item{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-family:'JetBrains Mono',monospace;font-size:0.75rem;}
.note-item:last-child{border-bottom:none;}
.note-pin{color:#8ac4f0;font-weight:700;white-space:nowrap;min-width:50px;}
.note-name{color:#f0a030;font-weight:700;white-space:nowrap;min-width:110px;}
.note-desc{color:#d0dce8;font-weight:700;}
.note-desc .shared-cables{color:#fdd835;}

.btn-danger{border-color:#6e2a2a;color:#e8a0a0;background:#2e1218;}
.btn-danger:hover{background:#4a1a22;border-color:#d53a3a;color:#fff;}

.upload-area{
    display:none;margin:10px auto;max-width:500px;padding:30px 20px;border:2px dashed #2a4a6e;
    border-radius:12px;background:rgba(18,37,62,0.5);cursor:pointer;transition:all 0.3s;
}
.upload-area.visible{display:block;}
.upload-area:hover,.upload-area.dragover{border-color:#3a7bd5;background:rgba(26,55,90,0.6);}
.upload-area p{font-size:0.9rem;color:#6a8ab0;margin:4px 0;}
.upload-area .upload-icon{font-size:2rem;margin-bottom:6px;}
.upload-area input[type="file"]{display:none;}

/* Connector type selector */
.type-selector{
    display:flex;flex-wrap:wrap;justify-content:center;gap:6px;
    margin:8px auto;max-width:900px;
}
.type-btn{
    padding:5px 12px;font-size:0.75rem;border:1px solid #2a4a6e;background:#12253e;
    color:#6a8ab0;border-radius:6px;cursor:pointer;transition:all 0.2s;
}
.type-btn:hover{border-color:#3a7bd5;color:#a0c4e8;}
.type-btn.active{background:#1a3a6a;border-color:#3a7bd5;color:#fff;}

.sep{width:1px;height:24px;background:#2a4a6e;margin:0 2px;}

/* Keyhole notch for round connectors */
.keyhole{
    position:absolute;top:-2px;left:50%;transform:translateX(-50%);
    width:16px;height:16px;background:#0a1628;border:3px solid #1a4a78;
    border-radius:50%;z-index:10;
}

@media print{
    body{background:#f5f0e8;color:#1a1a1a;}
    .connector-dsub,.connector-round{background:#f5f0e8;border-color:#333;box-shadow:none;}
    .toolbar,.toolbar-row,h2,.stats-bar,.cable-legend,.progress-wrap,.upload-area,.type-selector{display:none;}
    .pin.dimmed{opacity:0.1;}
    .show-pin-nums .pin-num-tooltip{color:#333;}
    .row.zone-solid{border:2px solid #333 !important;}
    .row.zone-outline{border:2px dashed #555 !important;}
    .pin.done .outer::after{display:none;}
    .connector-dsub.tracking-mode .pin.done .outer::after,.connector-round.tracking-mode .pin.done .outer::after{display:flex;color:rgba(0,150,60,0.7);}
    .pin.nc-pin{opacity:0.2;}
    .pin.split-pin .outer{border:2px dotted #3399cc !important;}
}
</style>
</head>
<body>

<!-- Site Navigation -->
<nav style="display:flex;justify-content:center;gap:16px;padding:10px 16px;background:rgba(12,25,45,0.95);border-bottom:1px solid #1a3a5a;">
    <a href="index.html" style="padding:6px 16px;font-family:'Outfit',sans-serif;font-weight:600;font-size:0.85rem;color:#a0c4e8;background:#12253e;border:1px solid #2a4a6e;border-radius:6px;text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor='#3a7bd5';this.style.color='#fff'" onmouseout="this.style.borderColor='#2a4a6e';this.style.color='#a0c4e8'">D-Sub 78 Pin Mapper</a>
    <a href="universal_viewer.html" style="padding:6px 16px;font-family:'Outfit',sans-serif;font-weight:700;font-size:0.85rem;color:#fff;background:#1a3a6a;border:1px solid #3a7bd5;border-radius:6px;text-decoration:none;">Universal Viewer</a>
    <a href="csv_generator.html" style="padding:6px 16px;font-family:'Outfit',sans-serif;font-weight:600;font-size:0.85rem;color:#a0c4e8;background:#12253e;border:1px solid #2a4a6e;border-radius:6px;text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor='#3a7bd5';this.style.color='#fff'" onmouseout="this.style.borderColor='#2a4a6e';this.style.color='#a0c4e8'">CSV Generator</a>
</nav>

<h2>Universal Connector Viewer
    <span id="viewBadge" class="badge">REAR VIEW</span>
    <span id="sourceBadge" class="badge badge-source">DEMO DATA</span>
    <span id="typeBadge" class="badge badge-type">D-SUB 78</span>
</h2>

<!-- Connector type selector -->
<div class="type-selector" id="typeSelector"></div>

<div class="toolbar">
    <button onclick="window.print()">ðŸ–¨ Print</button>
    <button onclick="toggleView()">ðŸ”„ Front/Rear</button>
    <div class="sep"></div>
    <div class="filter-group">
        <span class="filter-label">Cable:</span>
        <button class="nav-btn" onclick="navCable(-1)">â—€</button>
        <select id="cableFilter" onchange="filterPins()"></select>
        <button class="nav-btn" onclick="navCable(1)">â–¶</button>
    </div>
</div>

<div class="toolbar-row">
    <div class="checkbox-group">
        <input type="checkbox" id="showPinNums" onchange="togglePinNumbers()">
        <label for="showPinNums">Pin Numbers</label>
    </div>
    <div class="checkbox-group" id="editGroup">
        <input type="checkbox" id="editMode" onchange="toggleEditMode()">
        <label for="editMode">Edit Mode</label>
    </div>
    <div class="checkbox-group" id="trackingGroup">
        <input type="checkbox" id="trackingMode" onchange="toggleTrackingMode()">
        <label for="trackingMode">Pin Tracking</label>
    </div>
    <div class="sep"></div>
    <button onclick="downloadCSV()">ðŸ“¥ Download CSV</button>
    <button onclick="showUpload()">ðŸ“¤ Upload CSV</button>
    <div class="sep"></div>
    <button class="btn-danger" onclick="resetCableDone()">âŸ² Reset Cable</button>
    <button class="btn-danger" onclick="resetAllDone()">âŸ² Reset All</button>
    <button class="btn-danger" onclick="resetToDefault()">ðŸ—‘ Default Data</button>
</div>

<div class="upload-area" id="uploadArea" onclick="document.getElementById('csvFile').click()">
    <div class="upload-icon">ðŸ“„</div>
    <p><b>Drop CSV here</b> or click to browse</p>
    <p style="font-size:0.75rem;color:#4a6a88;">Supports: pin,name,color,cable_type OR pin,name,outer_color,inner_color,cable_type</p>
    <input type="file" id="csvFile" accept=".csv,.txt" onchange="handleFileUpload(event)">
</div>

<div class="stats-bar" id="statsBar"></div>
<div class="progress-wrap" id="progressWrap">
    <div class="progress-bar-outer"><div class="progress-bar-inner" id="progressBar"></div></div>
    <div class="progress-text" id="progressText"></div>
</div>
<div class="cable-legend" id="cableLegend"></div>

<div id="connectorWrap"></div>

<!-- Bottom nav -->
<div class="toolbar-row" style="margin-bottom:12px;">
    <button class="nav-btn" onclick="navCable(-1)">â—€ Prev</button>
    <span id="bottomCableLabel" style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:#6a9ac0;min-width:200px;display:inline-block;"></span>
    <button class="nav-btn" onclick="navCable(1)">Next â–¶</button>
</div>

<div class="notes-panel" id="notesPanel">
    <h3>âš¡ Shared / Special Pin Notes</h3>
    <div id="notesContent"></div>
</div>

<script>
// ===== CONNECTOR PRESETS =====
const connectorTypes = [
    {id:"dsub9",name:"D-Sub 9",pins:9,rows:[5,4],shape:"dsub"},
    {id:"dsub15",name:"D-Sub 15",pins:15,rows:[8,7],shape:"dsub"},
    {id:"dsub25",name:"D-Sub 25",pins:25,rows:[13,12],shape:"dsub"},
    {id:"dsub37",name:"D-Sub 37",pins:37,rows:[19,18],shape:"dsub"},
    {id:"dsub50",name:"D-Sub 50",pins:50,rows:[17,16,17],shape:"dsub"},
    {id:"dsub62",name:"D-Sub 62",pins:62,rows:[21,20,21],shape:"dsub"},
    {id:"dsub78",name:"D-Sub 78",pins:78,rows:[20,19,20,19],shape:"dsub"},
    {id:"dsub104",name:"D-Sub 104",pins:104,rows:[21,20,21,20,22],shape:"dsub"},
    {id:"round7",name:"Round 7",pins:7,rows:[1,6],shape:"round"},
    {id:"round19",name:"Round 19",pins:19,rows:[1,6,12],shape:"round"},
    {id:"round37",name:"Round 37",pins:37,rows:[1,6,12,18],shape:"round"},
];

// ===== DOM =====
const connectorWrap = document.getElementById("connectorWrap");
const viewBadge = document.getElementById("viewBadge");
const sourceBadge = document.getElementById("sourceBadge");
const typeBadge = document.getElementById("typeBadge");
const cableFilter = document.getElementById("cableFilter");
const statsBar = document.getElementById("statsBar");
const cableLegend = document.getElementById("cableLegend");
const progressWrap = document.getElementById("progressWrap");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const uploadArea = document.getElementById("uploadArea");
const trackingGroup = document.getElementById("trackingGroup");
const editGroup = document.getElementById("editGroup");
const notesPanel = document.getElementById("notesPanel");
const notesContent = document.getElementById("notesContent");
const bottomCableLabel = document.getElementById("bottomCableLabel");

let isFront=false, isTracking=false, isEditing=false;
let currentConnector = connectorTypes[6]; // D-Sub 78 default

const KEY_PINDATA="connector_pin_data", KEY_CABLETYPES="connector_cable_types",
      KEY_DONE="connector_done_pins", KEY_CONNTYPE="connector_type";

const namedColors = {
    shield:"#4a5568","dark grey":"#37474f",grey:"#a0aec0","light blue":"#4fc3f7",
    signal:"#00bcd4",blue:"#1976d2",white:"#f7fafc",brown:"#795548",
    green:"#388e3c",yellow:"#fdd835","dark pink":"#ad1457",pink:"#e91e63",
    red:"#e53935",black:"#1a202c",violet:"#9c27b0",orange:"#ff9800",cyan:"#00bcd4"
};

function resolveColor(name){
    if(!name) return "#e0e0e0";
    if(name.startsWith("#")) return name;
    const n=name.toLowerCase();
    const keys=Object.keys(namedColors).sort((a,b)=>b.length-a.length);
    for(const k of keys){if(n.includes(k)) return namedColors[k];}
    return "#e0e0e0";
}
function setTextColor(el,bg){
    const c=bg.toLowerCase();
    const light=["#f7fafc","#fdd835","#ffffff","#a0aec0","#4fc3f7"];
    el.style.color=light.includes(c)?"#1a202c":"#fff";
}

let pinData={}, cableTypesData={}, doneState={}, pinElements={}, cableGroups={}, sortedCables=[], isCustomData=false;

// ===== Helpers =====
function lsGet(k){try{const r=localStorage.getItem(k);return r?JSON.parse(r):null;}catch(e){return null;}}
function lsSet(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}
function lsRemove(k){try{localStorage.removeItem(k);}catch(e){}}

function getAllCableGroups(name){
    if(!name) return [];
    const parts=name.split("-")[0];
    return parts.split("+").map(s=>s.trim()).filter(s=>/^C\d+$/.test(s));
}
function getCableGroup(name){const g=getAllCableGroups(name);return g.length?g[0]:null;}
function isSharedPin(name){return getAllCableGroups(name).length>1;}
function isNC(data){
    if(!data) return false;
    const n=(data.name||"").trim().toUpperCase();
    return n==="NC"||n==="N/C"||n==="NO CONNECT"||n==="NOT CONNECTED";
}

// Split pin detection â€” same wire name on multiple pins
let splitPinMap={};
function buildSplitPinMap(){
    splitPinMap={};
    for(const[pin,data] of Object.entries(pinData)){
        if(isNC(data)||!data.name) continue;
        if(!splitPinMap[data.name]) splitPinMap[data.name]=[];
        splitPinMap[data.name].push(Number(pin));
    }
}
function getSplitPins(name){return splitPinMap[name]||[];}
function isSplitPin(name){return(splitPinMap[name]||[]).length>1;}
function shortenName(name){
    if(!name||name.length<=7) return name;
    const m=name.match(/^(C(\d+))\+(.+)-(.+)$/);
    if(m){
        const allParts=(m[1]+"+"+m[3]).split("+");
        const nums=allParts.map(s=>parseInt(s.replace("C",""))).sort((a,b)=>a-b);
        return `C${nums[0]}~${nums[nums.length-1]}${m[4]}`;
    }
    return name.substring(0,6)+"â€¦";
}
function autoDescription(data,pinNum){
    if(data.description) return data.description;
    const groups=getAllCableGroups(data.name);
    if(groups.length>1) return `Shield shared between ${groups.join(", ")} cables`;
    const splitPins=getSplitPins(data.name);
    if(splitPins&&splitPins.length>1) return `Wire split across Pin ${splitPins.join(", Pin ")}`;
    return "";
}

// ===== D-Sub 78 demo data =====
const defaultPinData={1:{name:"C25-S",color:"Shield"},2:{name:"C24-S",color:"Shield"},3:{name:"C22-S",color:"Shield"},4:{name:"C21-S",color:"Shield"},5:{name:"C20-S",color:"Shield"},6:{name:"C25-1",color:"White"},7:{name:"C25-2",color:"Brown"},8:{name:"C25-3",color:"Green"},9:{name:"C25-4",color:"Yellow"},10:{name:"C2-S",color:"Shield"},11:{name:"C25-5",color:"Grey"},12:{name:"C13-1",color:"Red"},13:{name:"C12-1",color:"Red"},14:{name:"C12-2",color:"Blue"},15:{name:"C1-S",color:"Shield"},16:{name:"C3-1",color:"Red"},17:{name:"C2-2",color:"Blue"},18:{name:"C2-1",color:"Red"},19:{name:"C1-2",color:"Blue"},20:{name:"C1-1",color:"Red"},21:{name:"C23-1",color:"Signal"},22:{name:"C22-1",color:"Signal"},23:{name:"C21-1",color:"Signal"},24:{name:"C20-1",color:"Signal"},25:{name:"C4-S",color:"Shield"},26:{name:"C25-6",color:"Pink"},27:{name:"C25-7",color:"Blue"},28:{name:"C25-8",color:"Red"},29:{name:"C25-9",color:"Black"},30:{name:"C6-S",color:"Shield"},31:{name:"C25-10",color:"Violet"},32:{name:"C13-2",color:"Blue"},33:{name:"C25-20",color:"Grey/Pink"},34:{name:"C5-S",color:"Shield"},35:{name:"C4-1",color:"Red"},36:{name:"C6-2",color:"Blue"},37:{name:"C6-1",color:"Red"},38:{name:"C5-2",color:"Blue"},39:{name:"C5-1",color:"Red"},41:{name:"C19-S",color:"Shield"},42:{name:"C18-S",color:"Shield"},43:{name:"C17-S",color:"Shield"},44:{name:"C16-S",color:"Shield"},45:{name:"C25-11",color:"Red/Blue"},46:{name:"C25-12",color:"White/Green"},47:{name:"C25-13",color:"Brown/Green"},48:{name:"C25-14",color:"White/Yellow"},49:{name:"C8-S",color:"Shield"},50:{name:"C25-15",color:"Yellow/Brown"},51:{name:"C14-2",color:"Blue"},52:{name:"C14-1",color:"Red"},54:{name:"C7-S",color:"Shield"},55:{name:"C3-2",color:"Blue"},56:{name:"C8-2",color:"Red"},57:{name:"C8-1",color:"Blue"},58:{name:"C7-2",color:"Red"},59:{name:"C7-1",color:"Blue"},60:{name:"C19-1",color:"Signal"},61:{name:"C18-1",color:"Signal"},62:{name:"C17-1",color:"Signal"},63:{name:"C16-1",color:"Signal"},64:{name:"C3-S",color:"Shield"},65:{name:"C25-16",color:"White/Grey"},66:{name:"C25-17",color:"Grey/Brown"},67:{name:"C25-18",color:"White/Pink"},68:{name:"C25-19",color:"Pink/Brown"},69:{name:"C11-S",color:"Shield"},70:{name:"C15-2",color:"Blue"},71:{name:"C15-1",color:"Red"},73:{name:"C9-S",color:"Shield"},74:{name:"C4-2",color:"Blue"},75:{name:"C11-1",color:"Red"},76:{name:"C10-1",color:"Blue"},77:{name:"C9-2",color:"Red"},78:{name:"C9-1",color:"Blue"}};
const defaultCableTypes={"C1":{type:"2-core cable"},"C2":{type:"20-core cable"},"C3":{type:"Coaxial"},"C4":{type:"Coaxial"},"C5":{type:"Coaxial"},"C6":{type:"Coaxial"},"C7":{type:"Coaxial"},"C8":{type:"Coaxial"},"C9":{type:"Coaxial"},"C10":{type:"Coaxial"},"C11":{type:"Coaxial"},"C12":{type:"2-core cable"},"C13":{type:"2-core cable"},"C14":{type:"2-core cable"},"C15":{type:"2-core cable"},"C16":{type:"Coaxial"},"C17":{type:"Coaxial"},"C18":{type:"Coaxial"},"C19":{type:"Coaxial"},"C20":{type:"Coaxial"},"C21":{type:"Coaxial"},"C22":{type:"Coaxial"},"C23":{type:"Coaxial"},"C24":{type:"Coaxial"},"C25":{type:"20-core cable"}};

// ===== Build type selector =====
function buildTypeSelector(){
    const el=document.getElementById("typeSelector");
    connectorTypes.forEach(ct=>{
        const btn=document.createElement("button");
        btn.className="type-btn"+(ct.id===currentConnector.id?" active":"");
        btn.textContent=ct.name+" ("+ct.pins+")";
        btn.onclick=()=>switchConnectorType(ct);
        el.appendChild(btn);
    });
}

function switchConnectorType(ct){
    currentConnector=ct;
    typeBadge.textContent=ct.name.toUpperCase();
    document.querySelectorAll(".type-btn").forEach((b,i)=>b.classList.toggle("active",connectorTypes[i].id===ct.id));
    lsSet(KEY_CONNTYPE,ct.id);
    // Clear and rebuild
    pinData={}; cableTypesData={}; doneState={};
    isCustomData=false;
    updateSourceBadge();
    buildCableGroups();buildSplitPinMap();
    buildDropdown();
    buildConnector();
    updateProgress();
    updateNotes("ALL");
}

// ===== INIT =====
function initData(){
    const savedType=lsGet(KEY_CONNTYPE);
    if(savedType){const ct=connectorTypes.find(c=>c.id===savedType);if(ct) currentConnector=ct;}
    typeBadge.textContent=currentConnector.name.toUpperCase();

    const savedPins=lsGet(KEY_PINDATA);
    const savedTypes=lsGet(KEY_CABLETYPES);
    doneState=lsGet(KEY_DONE)||{};
    if(savedPins){pinData=savedPins;cableTypesData=savedTypes||{};isCustomData=true;}
    else{pinData=JSON.parse(JSON.stringify(defaultPinData));cableTypesData=JSON.parse(JSON.stringify(defaultCableTypes));isCustomData=false;}
    updateSourceBadge();
    buildCableGroups();buildSplitPinMap();
    buildDropdown();
    buildConnector();
    updateProgress();
    updateNotes("ALL");
    bottomCableLabel.textContent=cableFilter.options[cableFilter.selectedIndex].textContent;
}

function updateSourceBadge(){
    sourceBadge.textContent=isCustomData?"CUSTOM DATA":"DEMO DATA";
    sourceBadge.style.background=isCustomData?"linear-gradient(135deg,#2ecc71,#1b8a3a)":"linear-gradient(135deg,#3a7bd5,#2a5faa)";
}

// ===== Cable groups =====
function buildCableGroups(){
    cableGroups={};
    for(const[pin,data] of Object.entries(pinData)){
        if(isNC(data)) continue;
        getAllCableGroups(data.name).forEach(grp=>{
            if(!cableGroups[grp]) cableGroups[grp]=[];
            const p=Number(pin);
            if(!cableGroups[grp].includes(p)) cableGroups[grp].push(p);
        });
    }
    sortedCables=Object.keys(cableGroups).sort((a,b)=>parseInt(a.replace("C",""))-parseInt(b.replace("C","")));
}

function buildDropdown(){
    cableFilter.innerHTML="";
    const allOpt=document.createElement("option");allOpt.value="ALL";
    const ncCount=Object.keys(pinData).filter(k=>isNC(pinData[k])).length;
    const ncStr=ncCount>0?`, ${ncCount} NC`:"";
    allOpt.textContent=`All Pins (${Object.keys(pinData).length}${ncStr})`;
    cableFilter.appendChild(allOpt);

    const typeGroups={};
    sortedCables.forEach(cable=>{
        const info=cableTypesData[cable];const t=info?info.type:"Other";
        if(!typeGroups[t]) typeGroups[t]=[];typeGroups[t].push(cable);
    });
    for(const[typeName,cables] of Object.entries(typeGroups)){
        const typePinSet=new Set();
        cables.forEach(c=>(cableGroups[c]||[]).forEach(p=>typePinSet.add(p)));
        const gh=document.createElement("option");gh.value="TYPE:"+typeName;
        gh.textContent=`â–¸ ${typeName} (${cables.length} cables, ${typePinSet.size} pins)`;
        gh.style.fontWeight="bold";cableFilter.appendChild(gh);
        cables.forEach(cable=>{
            const count=(cableGroups[cable]||[]).length;
            const opt=document.createElement("option");opt.value=cable;
            opt.textContent=`    ${cable} â€” ${typeName} (${count} pins)`;
            cableFilter.appendChild(opt);
        });
    }
}

// ===== BUILD CONNECTOR =====
function buildConnector(){
    connectorWrap.innerHTML="";pinElements={};
    if(currentConnector.shape==="round") buildRoundConnector();
    else buildDsubConnector();
}

function buildDsubConnector(){
    const el=document.createElement("div");
    el.className="connector-dsub";el.id="connector";
    let pinNumber=1;
    currentConnector.rows.forEach((count,idx)=>{
        const row=document.createElement("div");
        row.className="row "+(idx%2===0?"zone-solid":"zone-outline")+(idx%2?" offset":"");
        for(let i=0;i<count;i++){
            buildPin(row,pinNumber);pinNumber++;
        }
        el.appendChild(row);
    });
    connectorWrap.appendChild(el);
}

function buildRoundConnector(){
    const el=document.createElement("div");
    el.className="connector-round";el.id="connector";
    // Keyhole notch
    const keyhole=document.createElement("div");keyhole.className="keyhole";el.appendChild(keyhole);

    const cx=250,cy=250;// center of 500x500
    let pinNumber=1;
    const rings=currentConnector.rows;
    const totalRings=rings.length;

    rings.forEach((count,ringIdx)=>{
        if(count===1 && ringIdx===0){
            // Center pin
            const pin=document.createElement("div");
            pin.className="pin";
            pin.style.left=(cx-26)+"px";pin.style.top=(cy-26)+"px";
            buildPinContent(pin,pinNumber);
            el.appendChild(pin);pinElements[pinNumber]=pin;pinNumber++;
        } else {
            const radius=totalRings<=1?180:(80 + ringIdx*(180/(totalRings)));
            const startAngle=-90;// top
            for(let i=0;i<count;i++){
                const angle=startAngle+(i*(360/count));
                const rad=angle*Math.PI/180;
                const x=cx+radius*Math.cos(rad)-26;
                const y=cy+radius*Math.sin(rad)-26;
                const pin=document.createElement("div");
                pin.className="pin";
                pin.style.left=x+"px";pin.style.top=y+"px";
                buildPinContent(pin,pinNumber);
                el.appendChild(pin);pinElements[pinNumber]=pin;pinNumber++;
            }
        }
    });
    connectorWrap.appendChild(el);
}

function buildPin(container,pinNumber){
    const pin=document.createElement("div");pin.className="pin";
    buildPinContent(pin,pinNumber);
    container.appendChild(pin);pinElements[pinNumber]=pin;
}

function buildPinContent(pin,pinNumber){
    const data=pinData[pinNumber];
    pin.title=data?`Pin ${pinNumber}: ${data.name}`:`Pin ${pinNumber}`;

    const outer=document.createElement("div");outer.className="outer";
    const inner=document.createElement("div");inner.className="inner";
    applyPinColors(data,outer,inner);

    const pinIsNC=isNC(data);
    if(pinIsNC){pin.classList.add("nc-pin");pin.title=`Pin ${pinNumber} (NC)`;}
    if(!pinIsNC&&data&&isSharedPin(data.name)){pin.classList.add("shared-pin");pin.title=`Pin ${pinNumber}: ${data.name} (SHARED)`;}
    if(!pinIsNC&&data&&isSplitPin(data.name)){
        pin.classList.add("split-pin");
        const otherPins=getSplitPins(data.name).filter(p=>p!==pinNumber);
        pin.title=`Pin ${pinNumber}: ${data.name} (SPLIT â†’ also Pin ${otherPins.join(", ")})`;
    }
    if(!pinIsNC&&doneState[pinNumber]) pin.classList.add("done");

    const numLabel=document.createElement("span");numLabel.className="pin-num-tooltip";
    const fullName=data?data.name:"";const shortName=data?shortenName(data.name):"";
    numLabel.textContent="Pin "+pinNumber+(fullName&&fullName!==shortName?` (${fullName})`:"");

    const currentPin=pinNumber;
    if(!pinIsNC){
        pin.addEventListener("click",()=>{
            if(isTracking){
                doneState[currentPin]=!doneState[currentPin];lsSet(KEY_DONE,doneState);
                pin.classList.toggle("done",doneState[currentPin]);updateProgress();
                if(cableFilter.value!=="ALL") filterPins();
            } else if(isEditing){
                const t=prompt("Pin label:",inner.innerText);if(t!==null) inner.innerText=t;
                const oc=prompt("Outer color:",outer.style.background);if(oc) outer.style.background=oc;
                const ic=prompt("Inner color:",inner.style.background);if(ic){inner.style.background=ic;setTextColor(inner,ic);}
            }
        });
    }
    pin.appendChild(outer);pin.appendChild(inner);pin.appendChild(numLabel);
}

function applyPinColors(data,outer,inner){
    if(!data){outer.style.background="#2d3748";inner.style.background="#1a202c";inner.innerText="";return;}
    if(isNC(data)){outer.style.background="#1a202c";inner.style.background="#1a202c";inner.innerText="NC";inner.style.color="#4a5568";return;}
    inner.innerText=shortenName(data.name);
    if(data.outer_color&&data.inner_color){
        const c1=resolveColor(data.outer_color),c2=resolveColor(data.inner_color);
        outer.style.background=c1;inner.style.background=c2;setTextColor(inner,c2);
    }else if(data.color&&data.color.includes("/")){
        const p=data.color.split("/");outer.style.background=resolveColor(p[0]);inner.style.background=resolveColor(p[1]);setTextColor(inner,resolveColor(p[1]));
    }else{
        const c=resolveColor(data.color||data.outer_color||"");outer.style.background=c;inner.style.background=c;setTextColor(inner,c);
    }
}

// ===== View toggles =====
function toggleView(){
    isFront=!isFront;const el=document.getElementById("connector");
    if(el){el.classList.toggle("front-view",isFront);}
    viewBadge.innerText=isFront?"FRONT VIEW":"REAR VIEW";
}
function togglePinNumbers(){
    const el=document.getElementById("connector");
    if(el) el.classList.toggle("show-pin-nums",document.getElementById("showPinNums").checked);
}
function toggleTrackingMode(){
    isTracking=document.getElementById("trackingMode").checked;
    const el=document.getElementById("connector");
    if(el){el.classList.toggle("tracking-mode",isTracking);el.classList.remove("edit-mode");}
    trackingGroup.classList.toggle("tracking-active",isTracking);
    progressWrap.classList.toggle("visible",isTracking);
    if(isTracking&&isEditing){isEditing=false;document.getElementById("editMode").checked=false;editGroup.classList.remove("tracking-active");}
    if(isTracking) updateProgress();filterPins();
}
function toggleEditMode(){
    isEditing=document.getElementById("editMode").checked;
    const el=document.getElementById("connector");
    if(el){el.classList.toggle("edit-mode",isEditing);el.classList.remove("tracking-mode");}
    editGroup.classList.toggle("tracking-active",isEditing);
    if(isEditing&&isTracking){isTracking=false;document.getElementById("trackingMode").checked=false;trackingGroup.classList.remove("tracking-active");progressWrap.classList.remove("visible");filterPins();}
}

function navCable(dir){
    const opts=cableFilter.options;let idx=cableFilter.selectedIndex+dir;
    while(idx>=0&&idx<opts.length&&opts[idx].disabled) idx+=dir;
    if(idx>=0&&idx<opts.length){cableFilter.selectedIndex=idx;filterPins();}
}

// ===== Filter =====
function filterPins(){
    const val=cableFilter.value;
    bottomCableLabel.textContent=cableFilter.options[cableFilter.selectedIndex].textContent;
    let activePins=null;
    if(val==="ALL") activePins=null;
    else if(val.startsWith("TYPE:")){
        const tn=val.replace("TYPE:","");activePins=new Set();
        sortedCables.forEach(c=>{const info=cableTypesData[c];if((info?info.type:"Other")===tn)(cableGroups[c]||[]).forEach(p=>activePins.add(p));});
    }else activePins=new Set(cableGroups[val]||[]);

    let shown=0;
    for(const[pin,el] of Object.entries(pinElements)){
        const p=Number(pin);if(isNC(pinData[p])){el.classList.remove("highlighted");continue;}
        if(activePins===null){el.classList.remove("dimmed","highlighted");shown++;}
        else if(activePins.has(p)){el.classList.remove("dimmed");el.classList.add("highlighted");shown++;}
        else{el.classList.add("dimmed");el.classList.remove("highlighted");}
    }
    if(activePins===null) statsBar.innerHTML="";
    else{
        const list=[...activePins].sort((a,b)=>a-b).join(", ");
        const doneN=[...activePins].filter(p=>doneState[p]).length;
        const ds=isTracking?` â€” <span style="color:#2ecc71">${doneN}/${shown} done</span>`:"";
        statsBar.innerHTML=`Showing <span>${shown}</span> pins: ${list}${ds}`;
    }
    if(val!=="ALL"&&!val.startsWith("TYPE:")) buildLegend([val]);
    else if(val.startsWith("TYPE:")){const tn=val.replace("TYPE:","");buildLegend(sortedCables.filter(c=>{const i=cableTypesData[c];return(i?i.type:"Other")===tn;}));}
    else cableLegend.classList.remove("visible");
    updateNotes(val);
}

function buildLegend(cables){
    cableLegend.innerHTML="";const seen=new Set();
    cables.forEach(cable=>{(cableGroups[cable]||[]).slice().sort((a,b)=>a-b).forEach(p=>{
        if(seen.has(p)) return;seen.add(p);const d=pinData[p];if(!d) return;
        const c=resolveColor(d.color||d.outer_color||"");
        const shared=isSharedPin(d.name)?" âš¡":"";
        const split=isSplitPin(d.name)?" â†”":"";
        const item=document.createElement("span");
        item.className="legend-item"+(isTracking&&doneState[p]?" is-done":"");
        item.innerHTML=`<span class="legend-dot" style="background:${c}"></span>Pin ${p}: ${d.name}${shared}${split}${isTracking&&doneState[p]?" âœ“":""}`;
        cableLegend.appendChild(item);
    });});
    cableLegend.classList.add("visible");
}

function updateNotes(filterVal){
    notesContent.innerHTML="";let relevantPins=[];
    if(filterVal==="ALL") relevantPins=Object.keys(pinData).map(Number).sort((a,b)=>a-b);
    else if(filterVal.startsWith("TYPE:")){const tn=filterVal.replace("TYPE:","");const s=new Set();sortedCables.forEach(c=>{if((cableTypesData[c]?cableTypesData[c].type:"Other")===tn)(cableGroups[c]||[]).forEach(p=>s.add(p));});relevantPins=[...s].sort((a,b)=>a-b);}
    else relevantPins=(cableGroups[filterVal]||[]).slice().sort((a,b)=>a-b);
    let hasNotes=false;
    relevantPins.forEach(p=>{const d=pinData[p];if(!d) return;const desc=autoDescription(d,p);if(!desc) return;hasNotes=true;
        const groups=getAllCableGroups(d.name);const sharedList=groups.length>1?`<span class="shared-cables">${groups.join(", ")}</span>`:"";
        const splitPins=getSplitPins(d.name);const splitInfo=splitPins.length>1?`<span class="shared-cables">Pin ${splitPins.join(", Pin ")}</span>`:"";
        const item=document.createElement("div");item.className="note-item";
        item.innerHTML=`<span class="note-pin">Pin ${p}</span><span class="note-name">${d.name}</span><span class="note-desc">${desc}${sharedList?" â†’ "+sharedList:""}${splitInfo?" â†’ "+splitInfo:""}</span>`;
        notesContent.appendChild(item);
    });
    notesPanel.classList.toggle("visible",hasNotes);
}

function updateProgress(){
    const ap=Object.keys(pinData).filter(k=>!isNC(pinData[k]));
    const total=ap.length,done=ap.filter(k=>doneState[k]).length;
    const nc=Object.keys(pinData).length-total;
    const pct=total>0?Math.round((done/total)*100):0;
    progressBar.style.width=pct+"%";
    progressText.textContent=`${done} / ${total} connections done (${pct}%)${nc>0?" ("+nc+" NC)":""}`;
    progressBar.style.background=pct===100?"linear-gradient(90deg,#2ecc71,#27ae60)":"linear-gradient(90deg,#1b8a3a,#2ecc71)";
    progressText.style.color=pct===100?"#2ecc71":"#6aaa80";
}

// ===== Reset =====
function resetCableDone(){
    const val=cableFilter.value;if(val==="ALL"){alert("Select a cable first.");return;}
    let pins=[];
    if(val.startsWith("TYPE:")){const tn=val.replace("TYPE:","");sortedCables.forEach(c=>{if((cableTypesData[c]?cableTypesData[c].type:"Other")===tn) pins.push(...(cableGroups[c]||[]));});}
    else pins=cableGroups[val]||[];
    if(!confirm(`Reset done for ${pins.length} pins?`)) return;
    pins.forEach(p=>{doneState[p]=false;const el=pinElements[p];if(el) el.classList.remove("done");});
    lsSet(KEY_DONE,doneState);updateProgress();filterPins();
}
function resetAllDone(){
    if(!confirm("Reset ALL?")) return;doneState={};lsSet(KEY_DONE,doneState);
    for(const[p,el] of Object.entries(pinElements)) el.classList.remove("done");
    updateProgress();filterPins();
}
function resetToDefault(){
    if(!confirm("Reset to demo data?")) return;
    lsRemove(KEY_PINDATA);lsRemove(KEY_CABLETYPES);lsRemove(KEY_DONE);doneState={};initData();
}

// ===== CSV =====
function downloadCSV(){
    const lines=["pin,name,outer_color,inner_color,cable_type,description"];
    Object.keys(pinData).map(Number).sort((a,b)=>a-b).forEach(p=>{
        const d=pinData[p];if(!d) return;
        if(isNC(d)){lines.push(`${p},NC,,,,`);return;}
        let oc,ic;
        if(d.outer_color&&d.inner_color){oc=d.outer_color;ic=d.inner_color;}
        else if(d.color&&d.color.includes("/")){const pts=d.color.split("/");oc=pts[0];ic=pts[1];}
        else{oc=d.color||"";ic=d.color||"";}
        const groups=getAllCableGroups(d.name);
        const ctype=(cableTypesData[groups[0]]||{}).type||d.cable_type||"";
        const desc=(d.description||"").replace(/,/g,";");
        lines.push(`${p},${d.name},${oc},${ic},${ctype},${desc}`);
    });
    const blob=new Blob([lines.join("\n")],{type:"text/csv"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);
    a.download="connector_pinmap.csv";a.click();
}

function showUpload(){uploadArea.classList.toggle("visible");}
uploadArea.addEventListener("dragover",e=>{e.preventDefault();uploadArea.classList.add("dragover");});
uploadArea.addEventListener("dragleave",()=>uploadArea.classList.remove("dragover"));
uploadArea.addEventListener("drop",e=>{e.preventDefault();uploadArea.classList.remove("dragover");if(e.dataTransfer.files[0]) parseCSVFile(e.dataTransfer.files[0]);});
function handleFileUpload(e){if(e.target.files[0]) parseCSVFile(e.target.files[0]);e.target.value="";}

function parseCSVFile(file){
    const reader=new FileReader();
    reader.onload=e=>{try{
        const result=parseCSV(e.target.result);if(result.error){alert("CSV Error: "+result.error);return;}
        doneState={};lsSet(KEY_DONE,doneState);pinData=result.pinData;cableTypesData=result.cableTypes;isCustomData=true;
        lsSet(KEY_PINDATA,pinData);lsSet(KEY_CABLETYPES,cableTypesData);
        // Auto-detect connector type from pin count
        const maxPin=Math.max(...Object.keys(pinData).map(Number));
        const match=connectorTypes.find(ct=>ct.pins>=maxPin);
        if(match&&match.id!==currentConnector.id){currentConnector=match;typeBadge.textContent=match.name.toUpperCase();lsSet(KEY_CONNTYPE,match.id);document.querySelectorAll(".type-btn").forEach((b,i)=>b.classList.toggle("active",connectorTypes[i].id===match.id));}
        updateSourceBadge();buildCableGroups();buildSplitPinMap();buildDropdown();buildConnector();updateProgress();filterPins();updateNotes("ALL");
        uploadArea.classList.remove("visible");alert(`Loaded ${Object.keys(pinData).length} pins!`);
    }catch(err){alert("Parse error: "+err.message);}};
    reader.readAsText(file);
}

function parseCSV(text){
    const lines=text.trim().split(/\r?\n/);if(lines.length<2) return{error:"Need header + data"};
    const header=lines[0].split(",").map(h=>h.trim().toLowerCase());
    const pinIdx=header.indexOf("pin"),nameIdx=header.indexOf("name");
    if(pinIdx===-1) return{error:"Missing 'pin' column"};if(nameIdx===-1) return{error:"Missing 'name' column"};
    const ocIdx=header.indexOf("outer_color"),icIdx=header.indexOf("inner_color"),colorIdx=header.indexOf("color");
    const ctIdx=header.indexOf("cable_type"),descIdx=header.indexOf("description");
    const hasTwoColors=ocIdx!==-1&&icIdx!==-1,hasSingleColor=colorIdx!==-1;
    if(!hasTwoColors&&!hasSingleColor) return{error:"Missing color columns"};
    const newPinData={},newCableTypes={};
    for(let i=1;i<lines.length;i++){
        const cols=lines[i].trim().split(",").map(c=>c.trim());
        const pin=parseInt(cols[pinIdx]);if(isNaN(pin)||pin<1) continue;
        const name=cols[nameIdx]||"";const entry={name};
        const nu=name.trim().toUpperCase();const nc=nu==="NC"||nu==="N/C";
        if(nc) entry.color="";
        else if(hasTwoColors){entry.outer_color=cols[ocIdx]||"";entry.inner_color=cols[icIdx]||"";}
        else entry.color=cols[colorIdx]||"";
        if(ctIdx!==-1&&cols[ctIdx]) entry.cable_type=cols[ctIdx];
        if(descIdx!==-1&&cols[descIdx]) entry.description=cols[descIdx];
        newPinData[pin]=entry;
        const cables=getAllCableGroups(name);
        cables.forEach(c=>{if(c&&ctIdx!==-1&&cols[ctIdx]) newCableTypes[c]={type:cols[ctIdx]};});
    }
    if(!Object.keys(newPinData).length) return{error:"No valid pins"};
    return{pinData:newPinData,cableTypes:newCableTypes};
}

// ===== INIT =====
buildTypeSelector();
initData();
</script>
</body>
</html>
